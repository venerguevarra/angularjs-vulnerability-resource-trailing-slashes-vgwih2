// Import stylesheets and dependencies.
import './styles.css';

import angular from 'angular';
import ngResource from 'angular-resource';

// Define controllers.
class AppCtrl {
  urlSuffix = null;
  duration = '(N/A)';

  static $inject = ['$resource', '$http', '$q'];
  constructor($resource, $http, $q) {
    this.$resource = $resource;
    this.$http = $http;
    this.$q = $q;
    this.setUrlSuffixWithSlashesPowerOf2Exponent(0);
  }

  setUrlSuffixWithSlashesPowerOf2Exponent(exponent) {
    this.urlSuffix = `foo${'/'.repeat(2 ** exponent)}bar`;
    this.exponent = exponent;
  }

  fetchUsingHttp() {
    var url = `https://example.com/something/${this.urlSuffix}`;
    const canceller = this.$q.defer();
    let promise = this.$http
      .get(url, {
        timeout: canceller.promise,
      })
      .catch(angular.noop);
    promise.cancel = () => {
      canceller.resolve();
    };
    return promise;
  }

  fetchUsingResource() {
    const api = this.$http(
      `https://example.com/something/${this.urlSuffix}`,
      {},
      {},
      {
        cancellable: true,
      }
    );

    const start = performance.now();
    const items = api.query();
    const end = performance.now();

    this.duration = `${((end - start) / 1000).toFixed(2)} seconds`;
    console.log('exponent: ', this.exponent, ', duration: ', this.duration);

    // Cancel the request before it has a chance of being
    // sent; that's not what we're testing here.
    items.$cancelRequest();
  }

  sendRequestUsingHttp() {
    try {
      const start = performance.now();
      const usingHttp = this.fetchUsingHttp();
      const end = performance.now();
      this.duration = `${((end - start) / 1000).toFixed(2)} seconds`;
      console.log('exponent: ', this.exponent, ', duration: ', this.duration);

      usingHttp.cancel();
    } catch (err) {
      const isChromeBrowser = navigator.userAgent.includes('Chrome');
      const isTooMuchRecursionError =
        `${err}` === 'InternalError: too much recursion';

      let message = `The operation failed with the following error:\n\n    ${err}`;
      if (!isChromeBrowser && isTooMuchRecursionError) {
        message +=
          '\n\nTo avoid this error, it is recommended to run this test case in the Chrome browser.';
      }

      alert(message);
      console.error(err);

      this.duration = '(APP CRASHED)';
    }
  }

  sendRequestUsingResource() {
    try {
      fetchUsingResource();
    } catch (err) {
      const isChromeBrowser = navigator.userAgent.includes('Chrome');
      const isTooMuchRecursionError =
        `${err}` === 'InternalError: too much recursion';

      let message = `The operation failed with the following error:\n\n    ${err}`;
      if (!isChromeBrowser && isTooMuchRecursionError) {
        message +=
          '\n\nTo avoid this error, it is recommended to run this test case in the Chrome browser.';
      }

      alert(message);
      console.error(err);

      this.duration = '(APP CRASHED)';
    }
  }
}

// Define and configure the app.
angular.module('app', [ngResource]).controller('AppCtrl', AppCtrl);
